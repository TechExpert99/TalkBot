<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TalkBot — CameraBot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">TB</div>
      <div><div class="brand-title">TalkBot</div></div>
    </div>
  </header>

  <main class="camera-container">
    <h2>CameraBot Interface</h2>
    <!-- Video element to show live webcam -->
    <video id="cameraFeed" autoplay width="400" height="300"></video>

    <!-- Hidden canvas to capture frames for sending to backend -->
    <canvas id="snapshot" width="400" height="300" style="display:none;"></canvas>

    <!-- Display AI/CameraBot replies -->
    <div id="botReply"></div>

    <!-- Start camera button -->
    <button onclick="startCamera()">Start Camera</button>
  </main>

  <script>
    const video = document.getElementById('cameraFeed');
    const canvas = document.getElementById('snapshot');
    const ctx = canvas.getContext('2d');
    const botReply = document.getElementById('botReply');
    let streamStarted = false;

    // Start the webcam
    function startCamera() {
      if (streamStarted) return;
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          streamStarted = true;

          // Capture and send frames to backend every 1 second
          setInterval(sendFrame, 1000);
        })
        .catch(err => console.error("Camera error:", err));
    }

    // Capture current frame and send to backend
    async function sendFrame() {
      // Draw video frame to hidden canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Convert canvas to Base64 image
      const frame = canvas.toDataURL('image/jpeg');

      try {
        const response = await fetch("/camera", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ frame })
        });
        const data = await response.json();
        // Show backend response
        botReply.innerText = data.reply;
      } catch (err) {
        botReply.innerText = "⚠️ Error sending frame";
        console.error(err);
      }
    }
  </script>
</body>
</html>
